# üõ°Ô∏è Engine Security

[![CI/CD Pipeline](https://github.com/moreirawbmaster/engine-security/actions/workflows/ci.yml/badge.svg)](https://github.com/moreirawbmaster/engine-security/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/moreirawbmaster/engine-security/branch/main/graph/badge.svg)](https://codecov.io/gh/moreirawbmaster/engine-security)
[![Pub Version](https://img.shields.io/pub/v/engine_security)](https://pub.dev/packages/engine_security)
[![Pana Score](https://img.shields.io/badge/pana-100%2F100-brightgreen)](https://pub.dev/packages/engine_security/score)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-Android%20%7C%20iOS-blue)](https://pub.dev/packages/engine_security)

> **Sistema avan√ßado de detec√ß√£o de seguran√ßa para aplica√ß√µes Flutter focado em Android e iOS**

## üìã √çndice

- [Recursos](#-recursos)
- [Instala√ß√£o](#-instala√ß√£o)
- [Uso R√°pido](#-uso-r√°pido)
- [Detectores Dispon√≠veis](#-detectores-dispon√≠veis)
- [Modelos de Dados](#-modelos-de-dados)
- [Interface](#-interface)
- [Exemplos](#-exemplos)
- [Desenvolvimento](#-desenvolvimento)
- [Qualidade e Testes](#-qualidade-e-testes)
- [Contribui√ß√£o](#-contribui√ß√£o)
- [Licen√ßa](#-licen√ßa)

## üöÄ Recursos

- ‚úÖ **100% de Cobertura de Testes** - Todos os componentes testados
- üéØ **Pontua√ß√£o Pana 100/100** - Qualidade m√°xima no pub.dev
- üîÑ **CI/CD Automatizado** - Pipeline completo com GitHub Actions
- üì± **Android & iOS Exclusivo** - Otimizado para dispositivos m√≥veis
- üõ°Ô∏è **6 Detectores Especializados** - Frida, Root/Jailbreak, HTTPS Pinning, GPS Fake, Emulator, Debugger
- ‚ö° **Detec√ß√£o Ass√≠ncrona** - Performance otimizada
- üé® **API Intuitiva** - F√°cil integra√ß√£o e uso
- üìä **Sistema de Confian√ßa** - N√≠veis de confian√ßa calibrados
- üîí **Zero Depend√™ncias Externas** - Seguro e leve

## üì¶ Instala√ß√£o

Adicione ao seu `pubspec.yaml`:

```yaml
dependencies:
  engine_security: ^1.2.0
```

Execute:

```bash
flutter pub get
```

## ‚ö° Uso R√°pido

```dart
import 'package:engine_security/engine_security.dart';

void main() async {
  // Detectar Frida
  final fridaDetector = EngineFridaDetector();
  final fridaResult = await fridaDetector.performCheck();
  
  if (!fridaResult.isSecure) {
    print('‚ö†Ô∏è Frida detectado: ${fridaResult.details}');
    print('üéØ Confian√ßa: ${fridaResult.confidence}');
  }
  
  // Detectar Root/Jailbreak
  final rootDetector = EngineRootDetector();
  final rootResult = await rootDetector.performCheck();
  
  if (!rootResult.isSecure) {
    print('‚ö†Ô∏è Device comprometido: ${rootResult.details}');
  }
  
  // Verifica√ß√£o completa
  await performFullSecurityCheck();
}

Future<void> performFullSecurityCheck() async {
  final detectors = [
    EngineFridaDetector(),
    EngineRootDetector(),
    EngineHttpsPinningDetector(),
    EngineGpsFakeDetector(),
    EngineEmulatorDetector(),
    EngineDebuggerDetector(),
  ];
  
  print('üîç Executando verifica√ß√£o completa de seguran√ßa...\n');
  
  for (final detector in detectors) {
    if (detector.isAvailable) {
      final result = await detector.performCheck();
      final status = result.isSecure ? '‚úÖ' : '‚ùå';
      
      print('$status ${detector.detectorName}');
      print('   Confian√ßa: ${(result.confidence * 100).toStringAsFixed(1)}%');
      print('   Detalhes: ${result.details ?? 'N/A'}');
      print('');
    }
  }
}
```

## üõ°Ô∏è Detectores Dispon√≠veis

### 1. üî¥ Frida Detector (`EngineFridaDetector`)
- **Amea√ßa**: `SecurityThreatType.frida`
- **Confian√ßa**: 95%
- **M√©todos**: Detec√ß√£o de processos, bibliotecas e portas
- **Plataformas**: Android, iOS

### 2. üîë Root/Jailbreak Detector (`EngineRootDetector`)
- **Amea√ßa**: `EngineSecurityThreatType.rootJailbreak`
- **Confian√ßa**: 90%
- **M√©todos**: Arquivos de sistema, apps instalados, permiss√µes
- **Plataformas**: Android, iOS

### 3. üîí HTTPS Certificate Pinning Detector (`EngineHttpsPinningDetector`)
- **Amea√ßa**: `EngineSecurityThreatType.httpsPinning`
- **Confian√ßa**: 95%
- **M√©todos**: Valida√ß√£o de certificados SSL/TLS, fingerprints SHA-256
- **Plataformas**: Android, iOS
- **Formatos**: Base64 e Hexadecimal

### 4. üó∫Ô∏è GPS Fake Detector (`EngineGpsFakeDetector`)
- **Amea√ßa**: `EngineSecurityThreatType.gpsFake`
- **Confian√ßa**: 90%
- **M√©todos**: Mock location, apps falsos, consist√™ncia GPS, an√°lise de localiza√ß√£o
- **Plataformas**: Android, iOS

### 5. üì± Emulator Detector (`EngineEmulatorDetector`)
- **Amea√ßa**: `EngineSecurityThreatType.emulator`
- **Confian√ßa**: 85%
- **M√©todos**: Hardware, sensores, caracter√≠sticas do sistema
- **Plataformas**: Android, iOS

### 6. üêõ Debugger Detector (`EngineDebuggerDetector`)
- **Amea√ßa**: `EngineSecurityThreatType.debugger`
- **Confian√ßa**: 85%
- **M√©todos**: Processos de debug, timing attacks
- **Plataformas**: Android, iOS

## üîí HTTPS Certificate Pinning

O Engine Security inclui um sistema robusto de certificate pinning que protege contra ataques man-in-the-middle e intercepta√ß√£o de tr√°fego.

### Configura√ß√£o B√°sica

```dart
import 'package:engine_security/engine_security.dart';
import 'dart:io';

void setupCertificatePinning() {
  // Configurar pins para diferentes dom√≠nios
  final pins = [
    EngineCertificatePinModel(
      hostname: 'api.example.com',
      pins: [
        'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=', // SHA-256 em base64
        '0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef', // SHA-256 em hex
      ],
      includeSubdomains: true,
      enforcePinning: true,
    ),
    EngineCertificatePinModel(
      hostname: 'stmr.tech',
      pins: [
        '17a8d38a1f559246194bccae62a794ff80d419e849fa78811a4910d7283c1f75', // SHA-256 fingerprint real
      ],
      includeSubdomains: true,
      enforcePinning: true,
    ),
  ];

  // Configurar HttpOverrides global
  final httpOverrides = EngineSecurityHttpOverrides(
    pinnedCertificates: pins,
    onPinningValidation: (hostname, isValid, error) {
      print('Valida√ß√£o de pin para $hostname: ${isValid ? 'OK' : 'FALHA'}');
      if (error != null) print('Erro: $error');
    },
  );

  HttpOverrides.global = httpOverrides;
}
```

### Detector de Certificate Pinning

```dart
Future<void> checkCertificatePinning() async {
  final detector = EngineHttpsPinningDetector();
  final result = await detector.performCheck();
  
  if (!result.isSecure) {
    print('Certificate pinning n√£o est√° configurado!');
    print('Severidade: ${result.threatType.severityLevel}');
  }
}
```

### Exemplo Completo com stmr.tech

```dart
import 'package:flutter/material.dart';
import 'package:engine_security/engine_security.dart';
import 'package:http/http.dart' as http;
import 'dart:io';

class CertificatePinningDemo extends StatefulWidget {
  @override
  _CertificatePinningDemoState createState() => _CertificatePinningDemoState();
}

class _CertificatePinningDemoState extends State<CertificatePinningDemo> {
  String _validationStatus = 'N√£o testado';
  String _detectorStatus = 'N√£o verificado';

  @override
  void initState() {
    super.initState();
    _setupCertificatePinning();
  }

  void _setupCertificatePinning() {
    final pins = [
      EngineCertificatePinModel(
        hostname: 'stmr.tech',
        pins: ['17a8d38a1f559246194bccae62a794ff80d419e849fa78811a4910d7283c1f75'], // SHA-256 fingerprint real
        enforcePinning: true,
        includeSubdomains: true,
      ),
    ];

    HttpOverrides.global = EngineSecurityHttpOverrides(
      pinnedCertificates: pins,
      onPinningValidation: (hostname, isValid, error) {
        setState(() {
          _validationStatus = '$hostname: ${isValid ? 'V√ÅLIDO' : 'INV√ÅLIDO'}';
          if (error != null) _validationStatus += ' - $error';
        });
      },
    );
  }

  Future<void> _testHttpsConnection() async {
    try {
      final response = await http.get(Uri.parse('https://stmr.tech'));
      print('Conex√£o HTTPS bem-sucedida: ${response.statusCode}');
    } catch (e) {
      print('Erro na conex√£o HTTPS: $e');
    }
  }

  Future<void> _runPinningDetector() async {
    final detector = EngineHttpsPinningDetector();
    final result = await detector.performCheck();
    
    setState(() {
      _detectorStatus = result.isSecure ? 
        'CONFIGURADO - Certificate pinning ativo' : 
        'N√ÉO CONFIGURADO - ${result.details}';
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Certificate Pinning Demo')),
      body: Padding(
        padding: EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Status do Detector:', style: TextStyle(fontWeight: FontWeight.bold)),
                    Text(_detectorStatus),
                  ],
                ),
              ),
            ),
            SizedBox(height: 16),
            Card(
              child: Padding(
                padding: EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Status da Valida√ß√£o:', style: TextStyle(fontWeight: FontWeight.bold)),
                    Text(_validationStatus),
                  ],
                ),
              ),
            ),
            SizedBox(height: 20),
            ElevatedButton(
              onPressed: _runPinningDetector,
              child: Text('Verificar Certificate Pinning'),
            ),
            SizedBox(height: 10),
            ElevatedButton(
              onPressed: _testHttpsConnection,
              child: Text('Testar Conex√£o HTTPS com stmr.tech'),
            ),
          ],
        ),
      ),
    );
  }
}
```

## üìä Modelos de Dados

### EngineSecurityCheckModel

```dart
class EngineSecurityCheckModel {
  final bool isSecure;
  final EngineSecurityThreatType threatType;
  final double confidence;
  final String? details;
  final String? detectionMethod;
  final DateTime? timestamp;
  
  EngineSecurityCheckModel.secure({...});
  EngineSecurityCheckModel.threat({required EngineSecurityThreatType threatType, ...});
}
```

### EngineDetectorInfoModel

```dart
class EngineDetectorInfoModel {
  final String name;
  final EngineSecurityThreatType threatType;
  final bool enabled;
  final String platform;
}
```

### EngineCertificatePinModel

```dart
class EngineCertificatePinModel {
  final String hostname;
  final List<String> pins; // SHA-256 em base64 ou hexadecimal
  final bool includeSubdomains;
  final bool enforcePinning;
  
  // M√©todos de valida√ß√£o
  bool isValidPinFormat(String pin);
  bool matchesHostname(String host);
}
```

### EngineSecurityThreatType

```dart
enum EngineSecurityThreatType {
  unknown,        // Severidade: 5
  frida,          // Severidade: 9
  rootJailbreak,  // Severidade: 8
  httpsPinning,   // Severidade: 8
  gpsFake,        // Severidade: 7
  emulator,       // Severidade: 6
  debugger,       // Severidade: 2
}
```

## üîß Interface

### IEngineSecurityDetector

```dart
abstract class IEngineSecurityDetector {
  EngineSecurityThreatType get threatType;
  String get detectorName;
  Future<EngineSecurityCheckModel> detect();
  bool get isAvailable;
  EngineDetectorInfoModel get detectorInfo;
}
```

## üõ†Ô∏è Obtendo Fingerprints de Certificados

Para usar o certificate pinning, voc√™ precisa obter o fingerprint SHA-256 do certificado do seu servidor:

### M√©todo 1: Usando Engine Security (Autom√°tico)
```dart
// Obter o fingerprint diretamente do servidor ativo
final pinModel = await EngineHttpsPinningDetector.createPinFromLiveHost('stmr.tech');
print('Fingerprints obtidos: ${pinModel?.pins}');
```

### M√©todo 2: OpenSSL
```bash
echo | openssl s_client -connect stmr.tech:443 2>/dev/null | openssl x509 -fingerprint -sha256 -noout
```

### M√©todo 3: Chrome DevTools
1. Abra o site no Chrome
2. F12 ‚Üí Security ‚Üí View Certificate
3. Copie o SHA-256 fingerprint

### M√©todo 4: A partir de arquivo
```dart
// Se voc√™ tem um arquivo .crt ou .pem
final pinModel = await EngineHttpsPinningDetector.createPinFromCertificateFile(
  'api.example.com',
  '/path/to/certificate.crt',
);
```

### M√©todo 5: Hash conhecido
```dart
// Se voc√™ j√° tem o hash SHA-256
final pinModel = EngineHttpsPinningDetector.createPinFromHash(
  'stmr.tech',
  '17a8d38a1f559246194bccae62a794ff80d419e849fa78811a4910d7283c1f75',
);
```

## üì± Exemplos

Execute o exemplo interativo:

```bash
cd examples/security_demo
flutter run
```

### Implementa√ß√£o Personalizada

```dart
### Detector de GPS Fake - Exemplo Avan√ßado

```dart
import 'package:engine_security/engine_security.dart';

void main() async {
  final gpsDetector = EngineGpsFakeDetector();
  
  // Verifica√ß√£o b√°sica
  final result = await gpsDetector.performCheck();
  
  if (!result.isSecure) {
    print('‚ö†Ô∏è GPS Fake detectado!');
    print('üìç Detalhes: ${result.details}');
    print('üîç M√©todo: ${result.detectionMethod}');
    print('üéØ Confian√ßa: ${(result.confidence * 100).toStringAsFixed(1)}%');
    
    // Tomar a√ß√µes de seguran√ßa
    await handleGpsFakeDetection(result);
  } else {
    print('‚úÖ GPS √© confi√°vel');
  }
  
  // Verifica√ß√µes espec√≠ficas
  final mockEnabled = await EngineGpsFakeDetector.checkMockLocationEnabled();
  final fakeApps = await EngineGpsFakeDetector.getInstalledFakeGpsApps();
  
  print('üì± Mock Location habilitado: $mockEnabled');
  print('üö´ Apps de GPS Fake encontrados: ${fakeApps.length}');
  
  for (final app in fakeApps) {
    print('   - $app');
  }
}

Future<void> handleGpsFakeDetection(SecurityCheckModel result) async {
  // Bloquear funcionalidades baseadas em localiza√ß√£o
  // Registrar tentativa de fraude
  // Solicitar verifica√ß√£o adicional do usu√°rio
  // Etc.
}
```

### T√©cnicas de Detec√ß√£o de GPS Fake

O `EngineGpsFakeDetector` utiliza m√∫ltiplas t√©cnicas para detectar manipula√ß√£o de GPS:

#### 1. üîß Verifica√ß√£o de Mock Location (Android)
- Detecta se as "op√ß√µes de desenvolvedor" t√™m mock location habilitado
- Verifica configura√ß√µes do sistema Android

#### 2. üì± Detec√ß√£o de Apps de GPS Fake
- Verifica instala√ß√£o de mais de 25 apps conhecidos de GPS fake
- Lista atualizada dos principais apps de spoofing de localiza√ß√£o

#### 3. üìä An√°lise de Confiabilidade da Fonte
- Verifica precis√£o suspeita do GPS (< 100m pode indicar fake)
- Detecta valores imposs√≠veis (altitude e velocidade zero)

#### 4. üîÑ Verifica√ß√£o de Consist√™ncia GPS
- Analisa movimento imposs√≠vel entre leituras GPS
- Detecta "teletransporte" (dist√¢ncia > 1km em < 10s)

#### 5. üîê An√°lise de Permiss√µes
- Verifica interfer√™ncia em permiss√µes de localiza√ß√£o
- Detecta desabilita√ß√£o suspeita de servi√ßos de localiza√ß√£o

class MySecurityManager {
  final List<ISecurityDetector> _detectors = [
    EngineFridaDetector(),
    EngineRootDetector(),
    EngineEmulatorDetector(),
    EngineDebuggerDetector(),
  ];
  
  Future<List<SecurityCheckModel>> scanAllThreats() async {
    final results = <SecurityCheckModel>[];
    
    for (final detector in _detectors) {
      if (detector.isAvailable) {
        try {
          final result = await detector.performCheck();
          results.add(result);
        } catch (e) {
          results.add(SecurityCheckModel(
            isSecure: false,
            threatType: detector.threatType,
            confidence: 0.5,
            details: 'Erro na detec√ß√£o: $e',
          ));
        }
      }
    }
    
    return results;
  }
  
  Future<bool> isDeviceSecure({double minimumConfidence = 0.8}) async {
    final results = await scanAllThreats();
    
    for (final result in results) {
      if (!result.isSecure && result.confidence >= minimumConfidence) {
        return false;
      }
    }
    
    return true;
  }
}
```

## üîß Desenvolvimento

### Estrutura do Projeto

```
lib/
‚îú‚îÄ‚îÄ engine_security.dart           # Ponto de entrada principal
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ src.dart                    # Exporta√ß√µes centralizadas
    ‚îú‚îÄ‚îÄ detectors/                  # Detectores de seguran√ßa
    ‚îÇ   ‚îú‚îÄ‚îÄ i_security_detector.dart        # Interface base
    ‚îÇ   ‚îú‚îÄ‚îÄ engine_frida_detector.dart      # Detector Frida
    ‚îÇ   ‚îú‚îÄ‚îÄ engine_root_detector.dart       # Detector Root/Jailbreak
    ‚îÇ   ‚îú‚îÄ‚îÄ engine_emulator_detector.dart   # Detector Emulator
    ‚îÇ   ‚îî‚îÄ‚îÄ engine_debugger_detector.dart   # Detector Debugger
    ‚îú‚îÄ‚îÄ models/                     # Modelos de dados
    ‚îÇ   ‚îú‚îÄ‚îÄ security_check_model.dart       # Modelo de resultado
    ‚îÇ   ‚îî‚îÄ‚îÄ dector_info_model.dart          # Informa√ß√µes do detector
    ‚îî‚îÄ‚îÄ enums/                      # Enumera√ß√µes
        ‚îî‚îÄ‚îÄ security_threat_type.dart       # Tipos de amea√ßas

test/
‚îú‚îÄ‚îÄ all_tests.dart                  # Suite completa de testes
‚îú‚îÄ‚îÄ models/                         # Testes dos modelos
‚îú‚îÄ‚îÄ enums/                          # Testes dos enums
‚îú‚îÄ‚îÄ interface/                      # Testes da interface
‚îî‚îÄ‚îÄ detectors/                      # Testes dos detectores

examples/
‚îî‚îÄ‚îÄ security_demo/                  # App demonstrativo

scripts/
‚îú‚îÄ‚îÄ test_coverage.sh               # Script de cobertura
‚îî‚îÄ‚îÄ pana_analysis.sh              # Script de an√°lise Pana
```

### Scripts de Desenvolvimento

```bash
# Executar testes com cobertura
./scripts/test_coverage.sh

# An√°lise de qualidade Pana
./scripts/pana_analysis.sh

# An√°lise est√°tica
dart analyze

# Formata√ß√£o de c√≥digo
dart format .

# Publicar (dry-run)
dart pub publish --dry-run
```

## üß™ Qualidade e Testes

### Cobertura de Testes: 100%
- ‚úÖ Todos os modelos testados
- ‚úÖ Todos os enums testados
- ‚úÖ Interface completamente testada
- ‚úÖ Casos de borda cobertos
- ‚úÖ Tratamento de erros validado

### Pipeline CI/CD

- üîç **An√°lise Est√°tica** - dart analyze com warnings fatais
- üß™ **Testes Unit√°rios** - 100% de cobertura obrigat√≥ria
- üìä **Codecov Integration** - Relat√≥rios autom√°ticos de cobertura
- üìù **Pana Analysis** - Pontua√ß√£o 100/100 obrigat√≥ria
- üîí **Security Scan** - Verifica√ß√£o de vulnerabilidades
- üèóÔ∏è **Build Test** - Compila√ß√£o e teste dos exemplos
- üì¶ **Auto Publish** - Publica√ß√£o autom√°tica em tags

### Comandos de Qualidade

```bash
# Executar todos os testes
dart test

# Testes com cobertura
dart test --coverage=coverage
dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info --report-on=lib

# Verificar cobertura m√≠nima
dart pub global activate test_coverage
dart pub global run test_coverage --min-coverage=100

# An√°lise Pana
dart pub global activate pana
dart pub global run pana
```

## üîÑ CI/CD Status

| Pipeline | Status | Descri√ß√£o |
|----------|--------|-----------|
| Build | [![CI/CD Pipeline](https://github.com/moreirawbmaster/engine-security/actions/workflows/ci.yml/badge.svg)](https://github.com/moreirawbmaster/engine-security/actions/workflows/ci.yml) | An√°lise, testes e build |
| Coverage | [![codecov](https://codecov.io/gh/moreirawbmaster/engine-security/branch/main/graph/badge.svg)](https://codecov.io/gh/moreirawbmaster/engine-security) | Cobertura de testes |
| Quality | [![Pana Score](https://img.shields.io/badge/pana-100%2F100-brightgreen)](https://pub.dev/packages/engine_security/score) | Qualidade do c√≥digo |
| Publish | [![Pub Version](https://img.shields.io/pub/v/engine_security)](https://pub.dev/packages/engine_security) | Vers√£o publicada |

## ü§ù Contribui√ß√£o

1. Fork o projeto
2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)
3. Commit suas mudan√ßas (`git commit -am 'Adiciona nova feature'`)
4. Push para a branch (`git push origin feature/nova-feature`)
5. Abra um Pull Request

### Diretrizes de Contribui√ß√£o

- ‚úÖ Manter 100% de cobertura de testes
- ‚úÖ Seguir as conven√ß√µes Dart/Flutter
- ‚úÖ Adicionar documenta√ß√£o para APIs p√∫blicas
- ‚úÖ Testar em Android e iOS
- ‚úÖ Garantir pontua√ß√£o Pana 100/100

## üìÑ Licen√ßa

Este projeto est√° licenciado sob a MIT License - veja o arquivo [LICENSE](LICENSE) para detalhes.

## üèÜ Reconhecimentos

- Comunidade Dart/Flutter
- Contribuidores do projeto

---

<div align="center">

**üõ°Ô∏è Engine Security - Protegendo suas aplica√ß√µes Flutter**

[![Pub.dev](https://img.shields.io/badge/pub.dev-engine__security-blue)](https://pub.dev/packages/engine_security)

</div>

